<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="csrf-token" content={get_csrf_token()} />
    <.live_title default="GreenManTavern" suffix=" · Phoenix Framework">
      {assigns[:page_title]}
    </.live_title>
    <link phx-track-static rel="stylesheet" href={~p"/assets/css/app.css"} />
    <script defer phx-track-static type="text/javascript" src={~p"/assets/js/app.js"}>
    </script>
    <script>
      (() => {
        const setTheme = (theme) => {
          if (theme === "system") {
            localStorage.removeItem("phx:theme");
            document.documentElement.removeAttribute("data-theme");
          } else {
            localStorage.setItem("phx:theme", theme);
            document.documentElement.setAttribute("data-theme", theme);
          }
        };
        if (!document.documentElement.hasAttribute("data-theme")) {
          setTheme(localStorage.getItem("phx:theme") || "system");
        }
        window.addEventListener("storage", (e) => e.key === "phx:theme" && setTheme(e.newValue || "system"));
        
        window.addEventListener("phx:set-theme", (e) => setTheme(e.target.dataset.phxTheme));
        
        // Characters dropdown functionality
        document.addEventListener("click", function(event) {
          const dropdown = document.getElementById("characters-dropdown");
          const dropdownContainer = event.target.closest(".dropdown-container");
          
          if (dropdownContainer) {
            // Clicked inside dropdown container
            if (event.target.classList.contains("dropdown-button")) {
              // Toggle dropdown
              dropdown.style.display = dropdown.style.display === "none" ? "block" : "none";
            }
          } else {
            // Clicked outside dropdown - close it
            if (dropdown) {
              dropdown.style.display = "none";
            }
          }
        });

        // Character selection function - now uses URL parameters
        window.selectCharacterFromDropdown = function(characterId) {
          console.log("Character selected from dropdown:", characterId);
          
          // Store in session storage for persistence
          if (characterId) {
            sessionStorage.setItem('selectedCharacterId', characterId.toString());
          } else {
            sessionStorage.removeItem('selectedCharacterId');
          }
          
          // Navigate to current page with character parameter
          const currentPath = window.location.pathname;
          const newUrl = characterId ? `${currentPath}?character=${characterId}` : currentPath;
          window.location.href = newUrl;
        };

        // Load character from session storage on page load
        document.addEventListener('DOMContentLoaded', function() {
          const selectedCharacterId = sessionStorage.getItem('selectedCharacterId');
          if (selectedCharacterId) {
            console.log("Restoring character from session:", selectedCharacterId);
            // Update the select element
            const select = document.getElementById('character-select');
            if (select) {
              select.value = selectedCharacterId;
            }
          }
        });
          // Replace the existing chat JavaScript with this updated version
        // This handles BOTH user messages and character responses

        // Listen for new chat messages from LiveView
        window.addEventListener("phx:new-message", (e) => {
          const chatContainer = document.getElementById("chat-messages");
          if (!chatContainer) return;
          
          const { message } = e.detail;
          
          // Remove placeholder if it exists
          const placeholder = chatContainer.querySelector('p[style*="font-style: italic"]');
          if (placeholder) placeholder.remove();
          
          const messageDiv = document.createElement("div");
          messageDiv.id = `message-${message.id}`;
          
          if (message.type === "user") {
            // User message styling
            messageDiv.innerHTML = `
              <div style="margin-bottom: 8px; padding: 4px; border-left: 2px solid #666;">
                <div style="font-weight: bold; font-size: 10px; color: #666; margin-bottom: 2px;">You</div>
                <div style="color: #333;">${escapeHtml(message.content)}</div>
              </div>
            `;
          } else {
            // Character message styling
            messageDiv.innerHTML = `
              <div style="margin-bottom: 8px; padding: 4px; border-left: 2px solid #2d7d2d;">
                <div style="font-weight: bold; font-size: 10px; color: #2d7d2d; margin-bottom: 2px;">${escapeHtml(message.character_name)}</div>
                <div style="color: #333; white-space: pre-wrap;">${escapeHtml(message.content)}</div>
              </div>
            `;
          }
          
          chatContainer.appendChild(messageDiv);
          chatContainer.scrollTop = chatContainer.scrollHeight;
        });

        function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }
      })();
    </script>
  </head>
  <body>
    <div class="app-layout">
      <!-- Banner (fixed top) -->
      <div class="banner">
        <.banner_menu current_character={assigns[:character]} current_user={assigns[:current_user]} />
      </div>
      
      <%= if assigns[:is_auth_page] do %>
        <!-- Auth pages - simple layout -->
        {@inner_content}
      <% else %>
        <!-- Two-column content area -->
        <div class="content-wrapper">
          
          <!-- LEFT WINDOW: Static + Character Context -->
          <div class="left-container">
            <div class="mac-window">
              <div class="mac-title-bar">
                <div class="mac-close-box">×</div>
                <span class="mac-title">{assigns[:left_window_title] || "Green Man Tavern"}</span>
              </div>
              <div class="mac-content-area">
                <!-- ALWAYS RENDER: Tavern scene -->
                <div class="tavern-scene">
                  <img src="/images/the_tavern.png" alt="Green Man Tavern" style="width: 100%; display: block; border: 1px solid #000;" />
                </div>
                
                
                <!-- CONDITIONALLY RENDER: Selected character -->
                <%= if assigns[:character] do %>
                  <div class="character-content">
                    <div style="padding: 8px; border-top: 1px solid #CCC;">
                      <h2 style="font-size: 14px; margin-bottom: 8px; color: #000;"><%= @character.name %></h2>
                      <p style="font-size: 11px; color: #666; margin-bottom: 8px;">
                        <%= @character.archetype %>
                      </p>
                      
                      <!-- Focus Area -->
                      <div style="margin-bottom: 12px;">
                        <p style="font-weight: bold; margin-bottom: 4px; font-size: 11px;">Focus Area:</p>
                        <p style="margin-bottom: 8px; color: #666; font-size: 10px;">
                          <%= @character.focus_area %>
                        </p>
                      </div>
                      
                      <!-- Character portrait if available -->
                      <div style="margin-bottom: 8px;">
                        <img 
                          src={"/images/characters/#{@character.icon_name}.png"} 
                          alt={@character.name}
                          style="width: 100%; border: 1px solid #000; margin-bottom: 4px;"
                          onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
                        />
                        <div style="display: none; padding: 8px; border: 1px solid #CCC; background: #F9F9F9; text-align: center; font-size: 10px; color: #666;">
                          Icon: <%= @character.icon_name %>
                        </div>
                      </div>

                      <!-- Character description -->
                      <div style="margin-bottom: 12px;">
                        <p style="font-weight: bold; margin-bottom: 4px; font-size: 11px;">Description:</p>
                        <p style="margin-bottom: 8px; color: #666; font-size: 10px; line-height: 1.4;">
                          <%= @character.description %>
                        </p>
                      </div>

                      <!-- Personality traits -->
                      <div style="margin-bottom: 12px;">
                        <p style="font-weight: bold; margin-bottom: 4px; font-size: 11px;">Personality Traits:</p>
                        <ul style="margin-left: 16px; color: #666; font-size: 10px;">
                          <%= for trait <- @character.personality_traits do %>
                            <li><%= trait %></li>
                          <% end %>
                        </ul>
                      </div>

                      <!-- Trust level -->
                      <div style="margin-bottom: 16px; padding: 6px; border: 1px solid #CCC; background: #F9F9F9;">
                        <p style="font-weight: bold; margin-bottom: 4px; font-size: 11px;">Trust Level:</p>
                        <p style="font-size: 10px; color: #666;">
                          <strong><%= String.capitalize(@character.trust_requirement) %></strong>
                        </p>
                        <%= if @character.trust_requirement == "none" do %>
                          <p style="color: #2d7d2d; font-size: 10px; margin-top: 4px;">
                            ✓ Available to chat immediately!
                          </p>
                        <% else %>
                          <p style="color: #666; font-size: 10px; margin-top: 4px;">
                            Build trust to engage fully.
                          </p>
                        <% end %>
                      </div>

                      <!-- Chat Interface -->
                      <div style="border-top: 1px solid #CCC; padding-top: 12px;">
                        <h3 style="font-family: Chicago, 'Arial Black', sans-serif; font-size: 14px; margin-bottom: 8px;">
                          Chat with <%= @character.name %>
                        </h3>
                        
                        <!-- Chat messages area -->
                        <div id="chat-messages" style="height: 800px; border: 1px solid #CCC; background: #FFF; padding: 8px; margin-bottom: 8px; overflow-y: auto; font-size: 11px;">
                          <%= if assigns[:chat_messages] && length(assigns[:chat_messages]) > 0 do %>
                            <%= for message <- assigns[:chat_messages] do %>
                              <%= if message.type == :user do %>
                                <div style="margin-bottom: 8px; padding: 4px; border-left: 2px solid #666;">
                                  <div style="font-weight: bold; font-size: 10px; color: #666; margin-bottom: 2px;">You</div>
                                  <div style="color: #333;"><%= message.content %></div>
                                </div>
                              <% else %>
                                <div style="margin-bottom: 8px; padding: 4px; border-left: 2px solid #999;">
                                  <div style="font-weight: bold; font-size: 10px; color: #666; margin-bottom: 2px;"><%= @character.name %></div>
                                  <div style="color: #333;"><%= message.content %></div>
                                </div>
                              <% end %>
                            <% end %>
                          <% else %>
                            <p style="color: #999; font-style: italic; text-align: center; margin-top: 20px;">
                              Start a conversation with <%= @character.name %>...
                            </p>
                          <% end %>
                        </div>
                        
                        <!-- Chat input -->
                        <form phx-submit="send_message" style="display: flex; gap: 4px;">
                          <input 
                            type="text" 
                            name="message"
                            value={assigns[:current_message] || ""}
                            placeholder="Type your message..."
                            style="flex: 1; padding: 6px; border: 1px solid #CCC; font-size: 11px; font-family: Monaco, monospace;"
                          />
                          <button 
                            type="submit"
                            disabled={assigns[:is_loading]}
                            style="padding: 6px 12px; background: linear-gradient(180deg, #EFEFEF 0%, #D0D0D0 100%); border: 1px solid #CCC; font-size: 11px; cursor: pointer;"
                          >
                            <%= if assigns[:is_loading], do: "Sending...", else: "Send" %>
                          </button>
                        </form>
                      </div>
                    </div>
                  </div>
                <% else %>
                  <!-- Default tavern message -->
                  <div style="padding: 8px;">
                    <h2 style="font-size: 14px; margin-bottom: 8px; color: #000;">Welcome to the Green Man Tavern</h2>
                    <p style="font-size: 12px; color: #666; margin-bottom: 8px;">
                      Select a character from the dropdown above to begin your journey.
                    </p>
                    <p style="font-size: 11px; color: #999;">
                      Each character has unique knowledge and perspectives to share about permaculture and sustainable living.
                    </p>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
          
          <!-- RIGHT WINDOW: Page-Specific Content -->
          <div class="right-container">
            <div class="mac-window">
              <div class="mac-title-bar">
                <div class="mac-close-box">×</div>
                <span class="mac-title">{assigns[:right_window_title] || assigns[:page_title] || "Content"}</span>
              </div>
              <div class="mac-content-area">
                <!-- THIS IS WHERE LIVEVIEW PAGES RENDER -->
                {@inner_content}
              </div>
            </div>
          </div>
          
        </div>
      <% end %>
    </div>
  </body>
</html>
